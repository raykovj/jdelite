define("modules/flow/modelHandler",["modules/diagram/flowNode","modules/layout/flowLayout","modules/flow/flowModel","modules/flow/flowUtils","modules/common/map","modules/diagram/diagramUtils","modules/graph/graphConstants","modules/settings/config"],function(e,t,n,o,r,a,l,i){function s(e){function t(e,t,n){var o=e.getDummyPortsForSide(n);if(o.length>0)for(var r=0;r<o.length;r++){var a=t.getAllPortsForSide(n);t.insertDummyPort(a,o[r])}}function a(e){return e===l.bValue().TRUE||e===l.bValue().FALSE?e:l.settings().SWIM_LEVELS}function s(e){return e===l.bValue().TRUE||e===l.bValue().FALSE?e:l.settings().SWIM_LANES}function g(e){return e===l.linkStyle().SINGLE_ARROW||e===l.linkStyle().DOUBLE_ARROW?e:l.linkStyle().SINGLE_ARROW}function d(){for(var e=c.getFlowLinks(),t=[],n=0;n<e.length;n++)e[n].hasSegmentShifts()&&t.push(e[n]);return t}function u(e){if(i.hasStartEndLevels()&&v(e))for(var t=e.nodes,n=0;n<t.length;n++)t[n].levelNum++}function f(e){if(i.hasSideSwimLanes()&&L(e))for(var t=e.nodes,n=0;n<t.length;n++)t[n].laneNum++}function v(e){for(var t=e.nodes,n=0;n<t.length;n++)if(t[n].type!==l.flowId().START&&t[n].type!==l.flowId().END&&0===t[n].levelNum)return!0;return!1}function L(e){for(var t=e.nodes,n=0;n<t.length;n++)if(t[n].type!==l.flowId().LEFT_TOP&&t[n].type!==l.flowId().RIGHT_BOTTOM&&0===t[n].laneNum)return!0;return!1}var c=this,m=e,N=new n(e);c.getFlowModel=function(){return N},c.buildContentModel=function(e,t){t?(u(e),f(e)):c.updateFlowLinks(c.getFlowLinks()),N.buildFlowModel(e,t),m.getCaller().resetFlowDirectionChange()},c.getFlowNodes=function(){return N.getFlowNodes()},c.getFlowLinks=function(){return N.getFlowLinks()},c.updateFlowNodes=function(e){return N.updateFlowNodes(e)},c.updateFlowLinks=function(e){return N.updateFlowLinks(e)},c.getModelObject=function(){var e={};return e.nodes=N.getNodeObjects(),e.links=N.getLinkObjects(),e.settings=c.getSettings(),e},c.getModelObjectUpdated=function(e,t){return N.updateFlowNodes(e),N.updateFlowLinks(t),c.getModelObject()},c.cachePortOrders=function(e){for(var t=0;t<e.length;t++)e[t].setSrcPortOrder(e[t].getSourcePort().getOrder()),e[t].setTrgPortOrder(e[t].getTargetPort().getOrder())},c.updatePortsLayout=function(e){for(var n=N.getFlowNodes(),o=0;o<n.length;o++)for(var r=0;r<e.length;r++)if(n[o].equals(e[r])){t(n[o],e[r],l.nodeSide().FRONT),t(n[o],e[r],l.nodeSide().BACK),t(n[o],e[r],l.nodeSide().LEFT),t(n[o],e[r],l.nodeSide().RIGHT);break}},c.resetLinksToDefaults=function(){for(var e=c.getFlowLinks(),t=0;t<e.length;t++)e[t].resetToDefaults();for(var n=N.getLinkObjects(),o=0;o<n.length;o++)n[o].srcShift&&(n[o].srcShift=l.portShift().NONE),n[o].trgShift&&(n[o].trgShift=l.portShift().NONE),n[o].pipesOnly&&(n[o].pipesOnly=!1)},c.getModelObjectToSave=function(){var e={},t=[];e.nodes=N.getNodeObjects();for(var n=N.getFlowLinks(),o=0;o<n.length;o++)t.push(n[o].getLinkObjectToSave(!0));return e.links=t,e.settings=c.getSettings(),e},c.isDiagramEmpty=function(){return 0===c.getFlowNodes().length},c.getSettings=function(){var e={};return e.flowDirection=i.getFlowDirection(),e.layoutMode=i.getLayoutMode(),e.canvasLevels=i.getCanvasLevels(),e.canvasLanes=i.getCanvasLanes(),e.startEndLevels=i.getStartEndLevels(),e.sideSwimLanes=i.getSideSwimLanes(),e.autoGenNodeNames=i.hasAutoGenNodeNames(),e.showRefHandles=i.hasShowRefHandles(),e.linkStyle=i.getLinkStyle(),e},c.updateSettings=function(e){if(e&&e.settings){var t=e.settings;if(i.setFlowDirection(t.flowDirection?t.flowDirection:l.flow().VERTICAL),i.setLayoutMode(t.layoutMode?t.layoutMode:l.layoutMode().MANUAL),i.setStartEndLevels(a(t.startEndLevels)),i.setSideSwimLanes(s(t.sideSwimLanes)),m.isInitialResizeMode())i.setCanvasLevels(l.initial().LEVELS),i.setCanvasLanes(l.initial().LANES);else{var n=t.canvasLevels,r=o.getTotalCanvasLevels(e);r<=0&&(r=l.levelsRange().MIN),n&&Number.isInteger(n)?(n<=r?n=r:n>l.levelsRange().MAX&&(n=l.levelsRange().MAX),i.setCanvasLevels(n)):i.setCanvasLevels(r);var d=t.canvasLanes,u=o.getTotalCanvasLanes(e);u<=0&&(u=l.lanesRange().MIN),d&&Number.isInteger(d)?(d<=u?d=u:d>l.lanesRange().MAX&&(d=l.lanesRange().MAX),i.setCanvasLanes(d)):i.setCanvasLanes(u)}i.setAutoGenNodeNames(t.autoGenNodeNames),i.setShowRefHandles(t.showRefHandles),i.setLinkStyle(g(t.linkStyle))}},c.getDefaultSettings=function(){var e={};return e.flowDirection=l.flow().VERTICAL,e.layoutMode=l.layoutMode().MANUAL,e.canvasLevels=l.initial().LEVELS,e.canvasLanes=l.initial().LANES,e.startEndLevels=l.settings().SWIM_LEVELS,e.sideSwimLanes=l.settings().SWIM_LANES,e.showGrid=l.settings().SHOW_GRID,e.autoGenNodeNames=l.settings().AUTO_GEN,e.showRefHandles=l.settings().SHOW_REFS,e.linkStyle=l.linkStyle().SINGLE_ARROW,e},c.addNodeToModel=function(e){N.addNodeObject(e)},c.addLinkToModel=function(e){N.addLinkObject(e)},c.removeNodeFromModel=function(e){return N.removeNodeObject(e)},c.getNodeByNameAndType=function(e,t){return N.getNodeByNameAndType(e,t)},c.removeLinkFromModel=function(e){return N.removeLinkObject(e)},c.setNodeIndexProperty=function(e){N.setNodeIndexProperty(e)},c.setLinkIndexProperty=function(e){N.setLinkIndexProperty(e)},c.clearIndexProperties=function(){N.removeIndexProperties()},c.removeMultipleFromModel=function(e,t){var n,o=e.get("links"),r=e.get("nodes");if(o)for(n=0;n<o.length;n++)c.removeLinkFromModel(o[n]);if(r)for(n=0;n<r.length;n++)c.removeNodeFromModel(r[n])},c.addMultipleToModel=function(e,t){var n,o=e.get("nodes"),r=e.get("links");if(o)for(n=0;n<o.length;n++)c.addNodeToModel(o[n]);if(r)for(n=0;n<r.length;n++)c.addLinkToModel(r[n])},c.moveNodeToCell=function(e,t){N.moveNodeObject(e,t.getLevelNumber(),t.getLaneNumber())},c.moveNodeToPipe=function(e,t,n){N.moveNodeObject(e,t,n)},c.renameNodeInModel=function(e,t,n){var o,a,l,i,s,g=e.get("links"),d=[],u=[];if(g)for(o=0;o<g.length;o++){i=void 0,s=void 0;var f=g[o],v=f.source;a=v.indexOf("/"),l=v.substring(0,a),l==t&&(i=v.replace(t,n));var L=f.target;a=L.indexOf("/"),l=L.substring(0,a),l===t&&(s=L.replace(t,n));var c=N.renameLinkObject(f,i,s);u.push(c)}var m=e.get("nodes");if(m)for(o=0;o<m.length;o++){var S=m[o];if(S.name===t){var h=N.renameNodeObject(S,n);d.push(h)}}var w=new r;return w.put("nodes",d),w.put("links",u),w},c.changeDecisionEnds=function(e,t,n){N.changeDecisionEnds(e,t,n)},c.modifyNodeContentText=function(e,t){N.modifyNodeContent(e,t)},c.getSelectionsMapForItem=function(e){var t=[];return t.push(e),c.getSelectionObjectsMap(t)},c.getSelectionObjectsMap=function(e){for(var t=[],n=[],o=0;o<e.length;o++){var a,i=e[o];if(i.getId()===l.elementType().NODE){var s=i.getNodeObject();c.setNodeIndexProperty(s),t.push(s);for(var g=i.getConnectionPorts(),d=0;d<g.length;d++)for(var u=g[d].getEdgesList(),f=0;f<u.length;f++)a=u[f].getLinkObject(),c.setLinkIndexProperty(a),n.push(a)}else i.getId()===l.elementType().EDGE&&(a=i.getLinkObject(),c.setLinkIndexProperty(a),n.push(a))}var v=new r;return t.length>0&&v.put("nodes",t),n.length>0&&v.put("links",n),v},c.removeEmptyCorridors=function(e,t,n){var r,a,l=N.getNodeObjects(),s=m.getFlowDiagram().getFlowLayout(),g=N.isLevelEmpty(e);if(e>=0&&g){if(e<=o.getMaxLevelNumber(s))for(r=0;r<l.length;r++)a=l[r],a.levelNum>e&&a.levelNum--;i.removeCanvasLevel()}var d=N.isLaneEmpty(t);if(t>=0&&d){if(t<=o.getMaxLaneNumber(s))for(r=0;r<l.length;r++)a=l[r],a.laneNum>t&&a.laneNum--;i.removeCanvasLane()}},c.addCorridors=function(e,t,n){var r,a,l=N.getNodeObjects(),s=m.getFlowDiagram().getFlowLayout();if(e>=0){if(e<=(n?o.getTotalMaxLevelNumber(s):o.getMaxLevelNumber(s)))for(r=0;r<l.length;r++)a=l[r],a.levelNum>=e&&a.levelNum++;i.addCanvasLevel()}if(t>=0){if(t<=(n?o.getTotalMaxLaneNumber(s):o.getMaxLaneNumber(s)))for(r=0;r<l.length;r++)a=l[r],a.laneNum>=t&&a.laneNum++;i.addCanvasLane()}},c.setSegmentShift=function(e,t,n){for(var o=c.getFlowLinks(),r=0;r<o.length;r++)o[r].equals(e)&&o[r].setSegmentShift(t,n);N.updateFlowLinks(o)},c.clearSegmentShiftsToLinks=function(e,t){for(var n=c.getFlowLinks(),o=[],r=0;r<n.length;r++)for(var a=0;a<e.length;a++)n[r].getName()===e[a]&&(n[r].clearSegmentShifts(),o.push(n[r]));t?N.updateSelectedFlowLinks(o):N.updateFlowLinks(n)},c.clearAllSegmentShifts=function(){for(var e=c.getFlowLinks(),t=0;t<e.length;t++)e[t].clearSegmentShifts();N.updateFlowLinks(e)},c.haveLinksSegmentShifts=function(){for(var e=c.getFlowLinks(),t=0;t<e.length;t++)if(e[t].getTotalShifts().length>0)return!0;return!1},c.restoreSegmentShiftsToLinks=function(e,t){for(var n=c.getFlowLinks(),o=e.keys(),r=[],a=0;a<n.length;a++)for(var l=0;l<o.length;l++)n[a].getName()===o[l]&&(n[a].setSegmentShifts(e.get(o[l])),r.push(n[a]));t?N.updateSelectedFlowLinks(r):N.updateFlowLinks(n)},c.getPipeXSection=function(e,t,n,o){if(o>0&&e>0){var r=m.getFlowLayout().getLevels()[e];return m.getFlowLayout().getLanePipes()[o].intersection(r)}if(n>0&&t>0){var a=m.getFlowLayout().getLanes()[t];return m.getFlowLayout().getLevelPipes()[n].intersection(a)}},c.getLinksCrossingCell=function(e){var t=[];if(e)for(var n=d(),o=0;o<n.length;o++)for(var r=n[o],a=n[o].getSegments(),l=0;l<a.length;l++)if(e.isLineIntersecting(a[l].getStartPoint(),a[l].getEndPoint())){t.push(r);break}return t},c.changeStartEndLevels=function(e){var t,n=c.getFlowNodes();for(t=0;t<n.length;t++)n[t].getFlowType()!==l.flowType().START&&n[t].getFlowType()!==l.flowType().END&&(e===l.change().UP?n[t].levelNum++:e===l.change().DOWN&&n[t].levelNum--);N.updateFlowNodes(n),m.getCaller().updateWindow(),m.refreshDiagram()},c.changeSideSwimLanes=function(e){var t,n=c.getFlowNodes();for(t=0;t<n.length;t++)n[t].getFlowType()!==l.flowType().LEFT_TOP&&n[t].getFlowType()!==l.flowType().RIGHT_BOTTOM&&(e===l.change().UP?n[t].laneNum++:e===l.change().DOWN&&n[t].laneNum--);N.updateFlowNodes(n),m.getCaller().updateWindow(),m.refreshDiagram()}}return s});