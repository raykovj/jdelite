define("modules/flow/flowModel",["modules/diagram/flowNode","modules/diagram/flowLink","modules/diagram/decisionNode","modules/diagram/diagramUtils","modules/graph/graphConstants","modules/dialogs/messageDialog","modules/settings/config"],function(e,t,r,o,n,i,l){function f(f){function a(t,l){for(var f=0;f<t.length;f++){var a,u=t[f],d=u.name,s=o.getFlowType(u.type),T=u.decisionInput,g=u.decisionEnds;s!==n.flowType().NONE?(a=s===n.flowType().DECISION?new r(d,T,g):new e(d,s),a.setVisible(p(a)),a.setLevelNumber(u.levelNum),a.setLaneNumber(u.laneNum),a.setContentText(u.contentText?u.contentText:""),a.setInitialSize(),O&&console.log("+++ NODE: "+a.print1()),c(a)):i.showMessage("Error","node "+d+" has invalid type: "+u.type)}}function u(e,r){for(var l=N.getFlowNodes(),f=0;f<e.length;f++){var a=e[f],u=a.source.indexOf("/"),p=a.source.slice(0,u).trim(),g=a.source.slice(u+1).trim(),c=a.srcSide,m=a.target.indexOf("/"),w=a.target.slice(0,m).trim(),S=a.target.slice(m+1).trim(),h=a.trgSide,F=a.type,L=a.order,I=a.srcPortOrder,v=a.trgPortOrder,E=a.segmentShifts;if(T(p,g,w,S))i.showMessage("Error","DUPLICATE LINK: ["+a.source+"]-["+a.target+"], skipped");else{var P,R,D=void 0,b=void 0;for(R=0;R<l.length;R++)if(P=l[R],P.getName()===p){D=P;break}for(R=0;R<l.length;R++)if(P=l[R],P.getName()===w){b=P;break}if(D&&b){var k=new t("");r?k.setOrder(f):k.setOrder(L),c=d(D,b,c,F),h=s(D,b,h,F),k.setSourceShift(a.srcShift?a.srcShift:0),k.setTargetShift(a.trgShift?a.trgShift:0),k.setPipesOnly(a.pipesOnly);var _,C,M=F===n.linkType().REF_LINK?n.portType().LINK_REF:n.portType().LINK_CNX;D.isDecisionNode()?(g.indexOf(n.portNames().TRUE)>0?c=o.getDecisionTruePortSide(D):g.indexOf(n.portNames().FALSE)>0&&(c=o.getDecisionFalsePortSide(D)),_=D.createOutputPort(g,c,M)):a.srcShift===n.portShift().UP?(C=D.createOutputPort(void 0,c,n.portType().DUMMY),_=D.createOutputPort(g,c,M),C.setDummyParentName(_.getName()),O&&console.log("$$$$ SOURCE PORT UP: "+a.name+", shift="+a.srcShift+", order="+_.getOrder()+", dummy="+C.getOrder())):a.srcShift===n.portShift().DOWN?(_=D.createOutputPort(g,c,M),C=D.createOutputPort(void 0,c,n.portType().DUMMY),C.setDummyParentName(_.getName()),O&&console.log("$$$$ SOURCE PORT DOWN: "+a.name+", shift="+a.srcShift+", order="+_.getOrder()+", dummy="+C.getOrder())):_=D.createOutputPort(g,c,M),_&&(I&&I>=0&&_.setOrder(I),k.setSourcePort(_),k.setSourceSide(c));var G;if(a.trgShift===n.portShift().UP?(b.isDecisionNode()||(C=b.createInputPort(void 0,h,n.portType().DUMMY)),G=b.createInputPort(S,h,M),C&&C.setDummyParentName(G.getName()),O&&console.log("$$$$ TARGET PORT UP: "+a.name)):a.trgShift===n.portShift().DOWN?(G=b.createInputPort(S,h,M),b.isDecisionNode()||(C=b.createInputPort(void 0,h,n.portType().DUMMY),C.setDummyParentName(G.getName())),O&&console.log("$$$$ TARGET PORT DOWN: "+a.name)):G=b.createInputPort(S,h,M),G&&(v&&v>=0&&G.setOrder(v),k.setTargetPort(G),k.setTargetSide(h)),k.setType(F===n.linkType().REF_LINK?n.linkType().REF_LINK:n.linkType().CNX_LINK),E)for(var $=0;$<E.length;$++)k.setSegmentShift(E[$].order,E[$].pipeShift);k.isValid()&&(O&&console.log("+++ LINK: "+k.print()),y(k))}}}}function d(e,t,r,o,i){if(o===n.linkType().CNX_LINK){if(r)return e.getFlowType()===n.flowType().START||e.getFlowType()===n.flowType().END||e.getFlowType()===n.flowType().LEFT_TOP||e.getFlowType()===n.flowType().RIGHT_BOTTOM?e.getPreferredOutputSide():r}else if(o===n.linkType().REF_LINK){if(e.getFlowType()===n.flowType().START||e.getFlowType()===n.flowType().END||e.getFlowType()===n.flowType().LEFT_TOP||e.getFlowType()===n.flowType().RIGHT_BOTTOM)return e.getPreferredOutputSide();if(e.getFlowType()===n.flowType().PROCESS||e.getFlowType()===n.flowType().IN_OUT){if(e.getLaneNumber()<t.getLaneNumber())return l.getFlowDirection()===n.flow().VERTICAL?n.nodeSide().LEFT:n.nodeSide().RIGHT;if(e.getLaneNumber()>t.getLaneNumber())return l.getFlowDirection()===n.flow().VERTICAL?n.nodeSide().RIGHT:n.nodeSide().LEFT;if(r){if(!S.getCaller().hasFlowDirectionChange())return r;if(r===n.nodeSide().LEFT)return n.nodeSide().RIGHT;if(r===n.nodeSide().RIGHT)return n.nodeSide().LEFT}}}return e.getPreferredOutputSide()}function s(e,t,r,i,f){if(i===n.linkType().CNX_LINK){if(r)return t.getFlowType()===n.flowType().START||t.getFlowType()===n.flowType().END||t.getFlowType()===n.flowType().LEFT_TOP||t.getFlowType()===n.flowType().RIGHT_BOTTOM?t.getPreferredInputSide():t.getFlowType()===n.flowType().DECISION?o.getDecisionInputSide(t.getInput()):r}else if(i===n.linkType().REF_LINK){if(t.getFlowType()===n.flowType().START||t.getFlowType()===n.flowType().END||t.getFlowType()===n.flowType().LEFT_TOP||t.getFlowType()===n.flowType().RIGHT_BOTTOM)return t.getPreferredOutputSide();if(t.getFlowType()===n.flowType().PROCESS||t.getFlowType()===n.flowType().IN_OUT){if(t.getLaneNumber()<e.getLaneNumber())return l.getFlowDirection()===n.flow().VERTICAL?n.nodeSide().LEFT:n.nodeSide().RIGHT;if(t.getLaneNumber()>e.getLaneNumber())return l.getFlowDirection()===n.flow().VERTICAL?n.nodeSide().RIGHT:n.nodeSide().LEFT;if(r){if(!S.getCaller().hasFlowDirectionChange())return r;if(r===n.nodeSide().LEFT)return n.nodeSide().RIGHT;if(r===n.nodeSide().RIGHT)return n.nodeSide().LEFT}}}return t.getPreferredInputSide()}function p(e){return e.getFlowType()===n.flowType().LEFT_TOP||e.getFlowType()===n.flowType().RIGHT_BOTTOM?l.hasSideSwimLanes():e.getFlowType()!==n.flowType().START&&e.getFlowType()!==n.flowType().END||l.hasStartEndLevels()}function T(e,t,r,o){for(var n=0;n<I.length;n++){var i=I[n],l=i.source.indexOf("/"),f=i.source.slice(0,l).trim(),a=i.source.slice(l+1).trim(),u=i.target.indexOf("/"),d=i.target.slice(0,u).trim(),s=i.target.slice(u+1).trim();if(f===e&&a===t||d===r&&s===o)return!0}return!1}function g(){h=[],F=[],L=[],I=[]}function c(e){m(e)||(h.push(e),L.push(e.getNodeObject()))}function y(e){w(e)||(F.push(e),I.push(e.getLinkObject()))}function m(e){for(var t=0;t<h.length;t++)if(h[t].equals(e))return!0;return!1}function w(e){for(var t=0;t<F.length;t++)if(F[t].equals(e))return!0;return!1}var N=this,O=!1,S=f,h=[],F=[],L=[],I=[];N.getNodeObjects=function(){return L},N.getLinkObjects=function(){return I},N.getFlowNodes=function(){return h},N.getFlowLinks=function(){return F},N.updateFlowNodes=function(e){h=e,L=[];for(var t=0;t<e.length;t++)L.push(e[t].getNodeObject())},N.updateFlowLinks=function(e){F=e,I=[];for(var t=0;t<e.length;t++){var r=e[t].getLinkObject();I.push(r)}},N.updateSelectedFlowLinks=function(e){for(var t=0;t<I.length;t++)for(var r=0;r<e.length;r++)if(I[t].name===e[r].getName()){I.splice(t,1,e[r].getLinkObject());break}},N.addNodeObject=function(e){var t=e.order;t>-1?L.splice(t,0,e):L.push(e)},N.removeNodeObject=function(e){for(var t=0;t<L.length;t++)if(L[t].name===e.name&&L[t].type===e.type){var r=L[t].order;return L.splice(t,1),r}return-1},N.getNodeByNameAndType=function(e,t){for(var r=0;r<L.length;r++)if(L[r].name===e&&L[r].type===t)return L[r]},N.renameNodeObject=function(e,t){for(var r,o=0;o<L.length;o++)if(L[o].name===e.name&&L[o].type===e.type){L[o].name=t,r=L[o];break}return r},N.moveNodeObject=function(e,t,r){for(var o=0;o<L.length;o++)if(L[o].name===e.name&&L[o].type===e.type)return L[o].levelNum=t,L[o].laneNum=r,L[o]},N.changeDecisionEnds=function(e,t,r){for(var o=0;o<L.length;o++)if(L[o].name===e.name&&L[o].type===e.type){L[o].decisionInput=t,L[o].decisionEnds=r;break}},N.modifyNodeContent=function(e,t){for(var r=0;r<L.length;r++)if(L[r].name===e.name&&L[r].type===e.type){L[r].contentText=t;break}},N.addLinkObject=function(e){var t=e.order;t>-1?I.splice(t,0,e):I.push(e)},N.removeLinkObject=function(e){for(var t=0;t<I.length;t++)if(I[t].source===e.source&&I[t].target===e.target){var r=I[t].order;return I.splice(t,1),r}return-1},N.renameLinkObject=function(e,t,r){for(var o,n=0;n<I.length;n++)if(I[n].source===e.source&&I[n].target===e.target){t&&(I[n].source=t),r&&(I[n].target=r),(t||r)&&(o=I[n]);break}return o},N.setNodeIndexProperty=function(e){for(var t=0;t<L.length;t++)if(L[t].name===e.name&&L[t].type===e.type){L[t].order=t,e.order=t;break}},N.setLinkIndexProperty=function(e){for(var t=0;t<I.length;t++)if(I[t].source===e.source&&I[t].target===e.target){I[t].order=t,e.order=t;break}},N.removeIndexProperties=function(){var e;for(e=0;e<L.length;e++)L[e].order;for(e=0;e<I.length;e++)I[e].order},N.isLevelEmpty=function(e){for(var t=0;t<L.length;t++)if((l.hasStartEndLevels()||L[t].type!==n.flowId().START&&L[t].type!==n.flowId().END)&&L[t].levelNum==e)return!1;return!0},N.isLaneEmpty=function(e){for(var t=0;t<L.length;t++)if((l.hasSideSwimLanes()||L[t].type!==n.flowId().LEFT_TOP&&L[t].type!==n.flowId().RIGHT_BOTTOM)&&L[t].laneNum==e)return!1;return!0},N.buildFlowModel=function(e,t){g(),e&&e.nodes&&(a(e.nodes,t),e.links&&u(e.links,t))}}return f});