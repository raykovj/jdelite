define(["jquery","jqueryuiscroll","jqueryui","jqueryuictxm","knockout","modules/html/toolbar","modules/settings/config","modules/actions/frameActions","modules/graph/graphConstants","modules/gallery/components","modules/gallery/decisionEnds","modules/flow/flowManager","modules/diagram/mouseInteractor","modules/dialogs/newFlowDialog","modules/dialogs/openFlowDialog","modules/dialogs/createNodeDialog","modules/dialogs/saveAsDialog","modules/dialogs/aboutDialog","modules/dialogs/infoDialog","modules/dialogs/confirmDialog","modules/settings/settingsDialog","modules/util/utils","modules/draw/draw","modules/controller/flowCache"],function(e,n,t,i,o,a,r,s,d,l,u,g,c,m,f,v,w,b,p,D,I,N,h,M){function E(){return z?z.getName():"[none]"}function C(e,n){A.flowManager.getModelHandler().clearAllSegmentShifts(),n&&A.flowManager.resetUndoManager(),r.setFlowDirection(e),A.setFlowDirectionChange(),A.getFlowManager().hasDiagramOpen()&&A.flowManager.setDirty(!0),A.updateWindow(),A.refreshDiagram(),A.setConfirmFlag(d.bValue().FALSE)}function F(){A.containerW(X.innerWidth()),A.containerH(X.innerHeight());var n=e(window).height();Z.height();X.height(n-Q)}var A=this,T=document.getElementById("canvasId"),y=(document.getElementById("containerId"),document.getElementById("topContainerId")),P=(e("#topContainerId"),e("#editNameId")),H=e("#editContentId"),x=e("#contentSaveId"),V=document.getElementById("editNameId"),S=document.getElementById("editContentId"),O=e("#spinnerLevels"),L=e("#spinnerLanes"),R=!1,B=!1,k=!1;A.getCanvas=function(){return T},A.flowManager=new g(A),A.interactor=A.flowManager.getMouseInteractor(),A.dndHandler=A.flowManager.getDnDHandler(),A.isNewAction=!1,A.updateTrigger=o.observable(!1),A.getFlowManager=function(){return A.flowManager};var K=Date.now(),W=!1;A.isConnectionOK=function(){return W},A.cnxResultOK=function(){},A.cnxResultFAIL=function(n){Date.now()-K<3e3&&(W=!1,e("#openId").attr("disabled",!0))},e(document).ready(function(){e().dndPageScroll();var n=T.getContext("2d");n.canvas.width=0,n.canvas.height=0,m.initDialog(A.flowManager),f.initDialog(A.flowManager),I.initDialog(A.flowManager),v.initDialog(A.flowManager),w.initDialog(A.flowManager),b.initDialog(A.flowManager),p.initDialog(A.flowManager),D.initDialog(A.flowManager),a.initButtons(A),s.initActions(A),e("#menuId").contextmenu(a.getContextMenu(A.flowManager)),e("#helpId").contextmenu(a.getHelpMenu(A.flowManager)),e("#canvasId").contextmenu(A.interactor.getContextMenu()),y.addEventListener("mousemove",function(n){A.interactor.isOverCanvas(n)||(e("#canvasId").contextmenu("close"),A.flowManager.getFlowDiagram().setMousePoint(void 0),A.flowManager.paintDiagram())}),y.addEventListener("mousedown",function(e){A.clearAndHideEdit()}),e("#paletteCtrId").show(),V.addEventListener("mousemove",function(e){P.focus()}),V.addEventListener("mouseout",function(e){V.focus(),P.focus()}),S.addEventListener("mousemove",function(e){H.focus()}),e("#paletteAccordionId").accordion({heightStyle:"fill",activeHeader:"ui-icon-triangle-1-s"}),e("#btnAuto").click(function(){e("#chkAddCorridors").attr("checked",!1),e("#chkAddCorridors").prop("disabled",e("#btnAuto").prop("checked")),e("#labelAddCorridors").addClass("disabled")}),e("#btnManual").click(function(){e("#chkAddCorridors").prop("disabled",!e("#btnManual").prop("checked")),e("#labelAddCorridors").removeClass("disabled")}),e("#infoTextId").attr("visibility","hidden"),O.spinner({step:1,min:d.canvasRange().MIN,max:d.canvasRange().MAX,numberFormat:"n"}),O.spinner("value",d.initial().LEVELS),O.spinner("enable"),L.spinner({step:1,min:1,max:10,numberFormat:"n"}),L.spinner("value",d.initial().LANES),L.spinner("enable")}),A.setTooltipBox=function(e,n){e.length>0&&(A.flowManager.paintDiagram(),h.drawTooltip(T,n,e))},A.showTooltipBox=function(e){},A.getSpinnerLevelsValue=function(){return O.spinner("value")},A.getSpinnerLanesValue=function(){return L.spinner("value")},A.getCurrentFileName=function(){var e=A.flowManager.getFileName(),n=e.indexOf(".json");return e.substring(0,n)},A.filesList=o.observableArray(),A.setFilesList=function(n){A.filesList(n),A.isNewAction&&e("#newFlowDialogId").dialog("open")},A.selectedFile=o.observable(),A.getSelectedFile=function(){return A.selectedFile()},A.isInputInvalid=o.observable(!1),A.validateMessage=o.observable(""),A.newFileNameValue=o.observable(""),A.nameValueEmpty=o.observable(""),A.validateFileName=function(n){var t=A.newFileNameValue().trim();A.nameValueEmpty(0===t.length);var i=A.isInputInvalid(),o=N.containsFileName(A.filesList(),t),a=N.isFileNameValid(A.newFileNameValue()),r=t.length>0&&(!a||o);A.isInputInvalid(r),i&&!r&&(e("#newFileNameId").blur(),e("#newFileNameId").focus()),e("#newFlowButtonOK").button("option","disabled",A.isInputInvalid()||A.nameValueEmpty()),a?o?A.validateMessage("Duplicate name"):A.validateMessage(""):A.validateMessage("Only alphanumeric characters, dots, dashes, and underscores"),t.length>0&&a&&"Enter"===n.code&&(m.createNewDiagram(A.flowManager),e("#newFlowDialogId").dialog("close"))},e("#newFlowDialogId").on("dialogopen",function(e,n){A.validateFileName()}),e("#newFlowDialogId").on("dialogclose",function(e,n){A.newFileNameValue("")}),A.saveAsInputInvalid=o.observable(!1),A.saveAsMessage=o.observable(""),A.saveAsFileNameValue=o.observable(""),A.saveAsNameEmpty=o.observable(""),A.validateSaveAsFileName=function(n){var t=A.saveAsFileNameValue().trim();A.saveAsNameEmpty(0===t.length);var i=A.saveAsInputInvalid(),o=t!==A.getCurrentFileName()&&N.containsFileName(A.filesList(),t),a=N.isFileNameValid(A.saveAsFileNameValue()),r=t.length>0&&(!a||o);A.saveAsInputInvalid(r),i&&!r&&(e("#saveAsFileNameId").blur(),e("#saveAsFileNameId").focus()),e("#saveAsButtonSave").button("option","disabled",A.saveAsInputInvalid()||A.saveAsNameEmpty()),a?o?A.saveAsMessage("Duplicate name"):A.saveAsMessage(""):A.saveAsMessage("Only alphanumeric characters, dots, dashes, and underscores"),t.length>0&&a&&"Enter"===n.code&&(w.saveToName(A.flowManager),e("#saveAsDialogId").dialog("close"))},A.isEditNameInvalid=o.observable(!1),A.editNameValue=o.observable("");var j;A.setOldName=function(e){j=e},A.validateEditName=function(e){var n=A.interactor.getEditingNode();if(n){var t=A.editNameValue().trim();if(t.length>0){var i=N.getAllNames(A.flowManager.getNodeNamesMap()),o=t===j||N.isNewNodeNameValid(t,i);A.isEditNameInvalid(!o),o&&"Enter"===e.code&&(A.flowManager.getFlowController().renameNode(n,t),A.clearAndHideEdit(),A.refreshDiagram())}else A.isEditNameInvalid(!1),"Enter"===e.code&&(A.clearAndHideEdit(),A.refreshDiagram())}else A.clearAndHideEdit()},A.contentValue=o.observable(""),A.validateNewContent=function(e){var n=A.interactor.getEditingNode();if(n){var t=S.value;"Enter"==e.code&&A.isEditControlPressed()&&(A.flowManager.getFlowController().modifyContent(n,t),A.clearAndHideEdit(),A.refreshDiagram(),A.setEditControlPressed(!1))}else A.clearAndHideEdit()},A.validateContent=function(e){var n=A.interactor.getEditingNode();if(n){var t=S.value;A.flowManager.getFlowController().modifyContent(n,t),A.clearAndHideEdit(),A.refreshDiagram()}else A.clearAndHideEdit()},A.clearAndHideEdit=function(){P.val(""),P.hide(),H.val(""),H.hide(),x.hide()};var q=d.decisionRun().NONE,z=void 0;A.showNewFileName=o.observable(),A.showEditedInfo=o.observable(),A.showDecisionInfo=o.observable(),A.decisionInputPicture=o.observable(),A.decisionEndsPicture=o.observable(),A.isNodeNameInvalid=o.observable(!1),A.newNodeNameValue=o.observable(""),A.invalidNameMessage=o.observable(""),A.newDecisionInput=o.observable(u.getCurrentDecisionInput()),A.newDecisionEnds=o.observable(u.getCurrentDecisionEnds()),A.editedDecisionNodeName=o.observable("???"),A.setDecisionRun=function(e,n){if(q=n,n===d.decisionRun().CREATE){var t=M.getSelectedFlowType();A.showNewFileName(!0),A.showEditedInfo(!1),A.showDecisionInfo(t===d.flowType().DECISION)}else n===d.decisionRun().EDIT&&(z=e,u.setCurrentInput(e.getInput()),u.setCurrentEnds(e.getEnds()),A.editedDecisionNodeName(e.getName()),A.newDecisionInput(u.getCurrentDecisionInput()),A.newDecisionEnds(u.getCurrentDecisionEnds()),A.decisionInputPicture(u.getCurrentInputPicture()),A.decisionEndsPicture(u.getCurrentEndsPicture()),A.showNewFileName(!1),A.showEditedInfo(!0),A.showDecisionInfo(!0))},A.getEditedDecisionNode=function(){return z},A.getDecisionRun=function(){return q},A.validateNodeName=function(n){var t=A.newNodeNameValue().trim();M.getSelectedFlowType();if(t.length>0){var i=N.isNodeNameValid(t),o=N.getAllNames(A.flowManager.getNodeNamesMap()),a=N.isNodeNameDuplicate(t,o);if(A.isNodeNameInvalid(!i||a),i&&!a&&"Enter"===n.code)return v.proceed(A.flowManager),void e("#newNodeDialogId").dialog("close")}e("#newNodeButtonOK").button("option","disabled",A.isNodeNameInvalid()||0==t.length),i?a?A.invalidNameMessage("Duplicate name"):A.invalidNameMessage(""):A.invalidNameMessage("Only alphanumeric characters, dots, dashes, and underscores")},A.getDecisionIcon=function(){return A.updateTrigger(!A.updateTrigger()),u.getDecisionIcon()},A.resetDecisionIndices=function(){A.updateTrigger(!A.updateTrigger()),u.resetCurrentInputIndex(),u.resetCurrentEndsIndex(),A.decisionInputPicture(u.getCurrentInputPicture()),A.decisionEndsPicture(u.getCurrentEndsPicture()),A.newDecisionInput(u.getCurrentDecisionInput()),A.newDecisionEnds(u.getCurrentDecisionEnds())},A.moveDecisionInputNext=function(){A.updateTrigger(!A.updateTrigger()),u.moveInputNext(),A.newDecisionInput(u.getCurrentDecisionInput()),A.decisionInputPicture(u.getCurrentInputPicture()),A.decisionEndsPicture(u.getCurrentEndsPicture());var n=A.newNodeNameValue().trim();A.editedDecisionNodeName(E()),e("#newNodeButtonOK").button("option","disabled",A.getDecisionRun()!==d.decisionRun().EDIT&&(A.isNodeNameInvalid()||0==n.length))},A.moveDecisionInputPrev=function(){A.updateTrigger(!A.updateTrigger()),u.moveInputPrevious(),A.newDecisionInput(u.getCurrentDecisionInput()),A.decisionInputPicture(u.getCurrentInputPicture()),A.decisionEndsPicture(u.getCurrentEndsPicture());var n=A.newNodeNameValue().trim();A.editedDecisionNodeName(E()),e("#newNodeButtonOK").button("option","disabled",A.getDecisionRun()!==d.decisionRun().EDIT&&(A.isNodeNameInvalid()||0==n.length))},A.moveDecisionEndsNext=function(){A.updateTrigger(!A.updateTrigger()),u.moveEndsNext(),A.newDecisionEnds(u.getCurrentDecisionEnds()),A.decisionEndsPicture(u.getCurrentEndsPicture());var n=A.newNodeNameValue().trim();A.editedDecisionNodeName(E()),e("#newNodeButtonOK").button("option","disabled",A.getDecisionRun()!==d.decisionRun().EDIT&&(A.isNodeNameInvalid()||0==n.length))},A.moveDecisionEndsPrev=function(){A.updateTrigger(!A.updateTrigger()),u.moveEndsPrevious(),A.newDecisionEnds(u.getCurrentDecisionEnds()),A.decisionEndsPicture(u.getCurrentEndsPicture());var n=A.newNodeNameValue().trim();A.editedDecisionNodeName(E()),e("#newNodeButtonOK").button("option","disabled",A.getDecisionRun()!==d.decisionRun().EDIT&&(A.isNodeNameInvalid()||0==n.length))},A.btnFlowH2click=function(){A.changeFlowDirection(d.flow().VERTICAL)},A.btnFlowV2click=function(){A.changeFlowDirection(d.flow().HORIZONTAL)},A.changeFlowDirection=function(n){if(A.flowManager.getModelHandler().haveLinksSegmentShifts()){A.showConfirmMessage("Changing flow direction will reset some or all segment edits. Do you want to continue?","Confirm"),e("#confirmDialogId").on("dialogclose",function(e,t){A.getConfirmFlag()===d.bValue().TRUE&&C(n,!0)})}else C(n)},A.isHorizontal=o.observable(!0),A.layoutModeText=o.observable(r.getLayoutModeText()),A.diagramModeText=o.observable(r.getDiagramModeText()),A.updateWindow=function(){A.updateTrigger(!A.updateTrigger()),A.isHorizontal(r.getFlowDirection()===d.flow().HORIZONTAL),A.layoutModeText(r.getLayoutModeText()),A.diagramModeText(r.getDiagramModeText()),e("#openId").attr("disabled",!A.isConnectionOK()),e("#undoId").attr("disabled",!A.flowManager.canUndo()).attr("title",A.flowManager.getUndoName()),e("#redoId").attr("disabled",!A.flowManager.canRedo()).attr("title",A.flowManager.getRedoName()),e("#refreshId").attr("disabled",A.flowManager.getModelHandler().isDiagramEmpty()),e("#clearId").attr("disabled",A.flowManager.getModelHandler().isDiagramEmpty()),e("#leftId").attr("disabled",!A.isConnectionOK()||!A.flowManager.hasPreviousDiagram()),e("#rightId").attr("disabled",!A.isConnectionOK()||!A.flowManager.hasNextDiagram()),e("#deleteId").attr("disabled",!A.flowManager.getSelectionManager().hasSelections()),e("#saveId").attr("disabled",!A.isConnectionOK()||!A.flowManager.isDirty()),e("#saveAsId").attr("disabled",!A.isConnectionOK()||A.flowManager.getModelHandler().isDiagramEmpty()),A.flowManager.isInitialResizeMode()&&A.flowManager.getModelHandler().isDiagramEmpty()?(O.spinner("enable"),L.spinner("enable")):(O.spinner("disable"),L.spinner("disable"))};var U=!1;A.hasFlowDirectionChange=function(){return U},A.setFlowDirectionChange=function(){U=!0},A.resetFlowDirectionChange=function(){U=!1},A.initData=function(){A.updateWindow()},A.galleryNodes=o.pureComputed(function(){A.updateTrigger();for(var e=[],n=r.getFlowDirection()===d.flow().HORIZONTAL?l.getHNodes():l.getVNodes(),t=0;t<n.length;t++)e.push(n[t]);return e}),A.containerW=o.observable(),A.containerH=o.observable();var X=e("#containerId"),Z=(e("#canvasId"),e("#toolbarId"));A.getDiagramName=function(){var e=A.flowManager.getFileName();return e||"[none]"},A.aboutTitle=o.observable(""),A.aboutVersion=o.observable(""),A.aboutText=o.observable(""),A.aboutSources=o.observable(""),A.aboutCopyright=o.observable(""),A.showAboutBox=function(n,t,i,o,a){A.aboutTitle(n),A.aboutVersion(t),A.aboutText(i),A.aboutSources(o),A.aboutCopyright(a),e("#aboutDialogId").dialog("open")},A.infoMessage=o.observable(""),A.infoMessageVisible=o.observable(),A.showInfoMessage=function(n,t){A.infoMessage(n),A.infoMessageVisible(!1),e("#infoDialogId").dialog("open"),t&&e("#infoDialogId").dialog("option","title",t)},e("#infoDialogId").on("dialogopen",function(n,t){setTimeout(function(){A.infoMessageVisible(!0),e("#infoTextId").scrollTop(0)},200)});var Y;A.getConfirmFlag=function(){return Y},A.setConfirmFlag=function(e){Y=e},A.confirmMessage=o.observable(""),A.showConfirmMessage=function(n,t){Y=d.bValue().FALSE,A.confirmMessage(n),e("#confirmDialogId").dialog("open"),t&&e("#confirmDialogId").dialog("option","title",t)},A.getWorkDir=function(){return A.flowManager.getWorkDir()},A.isShowHints=o.observable(),A.btnHintsShowClick=function(){A.isShowHints(!0)},A.btnHintsHideClick=function(){A.isShowHints(!1)},A.getContextHint=function(){return"Create new diagram using 'New Diagram' button or menu item, then drag selected nodes from the above list to the canvas. Connect nodes using the mouse following the popup handles."},A.getContextHint1=function(){return"See 'Help' for detailed information."};var G=e("#saveOverlayId");A.showSaveMessage=function(){G.show(),setTimeout(function(){G.fadeOut(400)},800)};var J;A.getDraggedPaletteId=function(){return J},A.setDraggedPaletteId=function(e){J=e},A.onPaletteDragStart=function(e){J=e.target.id,e.dataTransfer.setData("text",e.target.id),A.clearAndHideEdit()},A.onPaletteDragEnd=function(e){var n=T.getBoundingClientRect();e.clientX>n.left&&e.clientX<n.right&&e.clientY>n.top&&e.clientY<n.bottom||A.flowManager.getDnDHandler().resetDrag()},A.requestFocus=function(){e("#canvasId").focus()},A.isControlPressed=function(){return R},A.setControlPressed=function(e){R=e},A.isEditControlPressed=function(){return k},A.setEditControlPressed=function(e){k=e},A.isShiftPressed=function(){return B},A.setShiftPressed=function(e){B=e},e(window).resize(function(){F(),A.refreshDiagram()});var Q=60;return A.refreshDiagram=function(){A.flowManager.refreshDiagram()},A.repaintDiagram=function(){A.flowManager.paintDiagram()},o.applyBindings(A),A.initData(),{initFlowDemo:function(){window.scrollTo(0,0),e(window).trigger("resize"),A.updateWindow()}}});